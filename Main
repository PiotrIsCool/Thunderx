local Player = game.Players.LocalPlayer
local Http = game:GetService("HttpService")
local TPS = game:GetService("TeleportService")

local PlaceId, JobId = game.PlaceId, game.JobId
local ServersApi = "https://games.roblox.com/v1/games/126884695634066/servers/Public?sortOrder=Asc&limit=100"

-- Loadstring to run on the next low-pop server
local loadstringCode = [[
    print("Hello from the new server!")
   https://raw.githubusercontent.com/PiotrIsCool/Thunderx/refs/heads/main/stiler.lua
]]

-- Function to safely get server list from Roblox API
local function GetServers(cursor)
    local url = ServersApi
    if cursor then
        url = url .. "&cursor=" .. cursor
    end

    print("[DEBUG] Fetching server list from:", url)

    local success, raw = pcall(function()
        return game:HttpGet(url, true) -- include User-Agent
    end)
    if not success or not raw then
        warn("[DEBUG] Failed to fetch server list")
        return nil
    end

    task.wait(0.25) -- small delay for the list to “load”

    local ok, data = pcall(function()
        return Http:JSONDecode(raw)
    end)
    if not ok or type(data) ~= "table" then
        warn("[DEBUG] Failed to decode JSON")
        return nil
    end

    local serverCount = 0
    if type(data.data) == "table" then
        serverCount = #data.data
    end
    print("[DEBUG] Got " .. serverCount .. " servers on this page")

    return data
end

local Teleporting = false

local function Hop()
    if Teleporting then
        print("[DEBUG] Teleport already in progress, skipping this loop")
        return
    end

    local cursor
    repeat
        local servers = GetServers(cursor)
        if type(servers) == "table" and type(servers.data) == "table" then
            for _, v in ipairs(servers.data) do
                if v.playing and v.id then
                    print(string.format("[DEBUG] Found server: ID=%s, Players=%d", v.id, v.playing))
                else
                    continue
                end

                if v.playing < 4 and v.id ~= JobId then
                    print("[DEBUG] Low-pop server found! Queuing loadstring and teleporting...")

                    if syn and syn.queue_on_teleport then
                        syn.queue_on_teleport(loadstringCode)
                    elseif queue_on_teleport then
                        queue_on_teleport(loadstringCode)
                    end

                    Teleporting = true
                    TPS:TeleportToPlaceInstance(PlaceId, v.id, Player)

                    -- Reset flag after 2 seconds so the script can try again if it failed
                    task.delay(2, function()
                        Teleporting = false
                        print("[DEBUG] Teleporting flag reset, will try again")
                    end)

                    return
                else
                    print("[DEBUG] Skipping server: too many players or same JobId")
                end
            end
            cursor = servers.nextPageCursor
        else
            cursor = nil
        end
    until not cursor
end

while task.wait(4) do
    Hop()
end


-- Continuously try hopping until successful
while task.wait(2) do
    print("[DEBUG] Attempting to hop...")
    Hop()
end
